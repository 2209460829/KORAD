<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯ç¼–ç¨‹ç”µæºæ§åˆ¶ç³»ç»Ÿ</title>
    <meta http-equiv="Permissions-Policy" content="serial=(self)" />
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1a2980, #26d0ce);
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
            padding: 10px;
        }

        .container {
            width: 100%;
            min-width: 900px;
            margin: 0 auto;
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }

        header {
            background: linear-gradient(to right, #2c3e50, #34495e);
            color: white;
            padding: 15px 20px;
            text-align: center;
            border-bottom: 3px solid #3498db;
        }

        h1 {
            font-size: 24px;
            margin-bottom: 5px;
            color: #fff;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .subtitle {
            font-size: 14px;
            opacity: 0.9;
            color: #ecf0f1;
        }

        .content {
            display: grid;
            grid-template-columns: 1fr 1.2fr;
            gap: 15px;
            padding: 20px;
            width: 100%;
        }

        @media (max-width: 1024px) {
            .content {
                grid-template-columns: 1fr;
            }
        }

        .control-panel,
        .display-panel {
            background: linear-gradient(145deg, #f8f9fa, #e9ecef);
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            border: 1px solid #dee2e6;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #3498db;
        }

        .panel-title {
            font-size: 18px;
            color: #2c3e50;
            font-weight: 600;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #e74c3c;
            box-shadow: 0 0 8px currentColor;
        }

        .status-connected {
            background-color: #2ecc71;
            box-shadow: 0 0 8px #2ecc71;
        }

        .parameter-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .parameter-box {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: 1px solid #ddd;
            transition: transform 0.3s ease;
        }

        .parameter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .parameter-title {
            font-size: 16px;
            font-weight: 600;
            color: #2c3e50;
        }

        .parameter-value {
            font-size: 20px;
            font-weight: 700;
            color: #3498db;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
        }

        .slider-container {
            margin: 10px 0;
        }

        .slider-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 12px;
            color: #7f8c8d;
        }

        input[type="range"] {
            width: 100%;
            height: 5px;
            -webkit-appearance: none;
            background: linear-gradient(to right, #3498db, #2c3e50);
            border-radius: 3px;
            outline: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #2c3e50;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            transition: all 0.2s;
        }

        .input-group {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .input-group input {
            flex: 1;
            padding: 8px 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            text-align: center;
            transition: border-color 0.3s;
        }

        .input-group button {
            padding: 8px 15px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s;
        }

        .quick-commands {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 8px;
            margin: 15px 0;
        }

        .cmd-btn {
            padding: 8px;
            background: linear-gradient(145deg, #2c3e50, #34495e);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 12px;
            transition: all 0.3s;
        }

        .serial-controls {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .serial-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .serial-config {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .config-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .config-group label {
            font-weight: 600;
            color: #2c3e50;
            font-size: 12px;
        }

        .config-group select {
            padding: 8px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 12px;
            background: white;
            transition: border-color 0.3s;
        }

        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 8px;
            margin-top: 15px;
        }

        .action-btn {
            padding: 8px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 12px;
            transition: all 0.3s;
        }

        .display-area {
            background: #1a1a1a;
            color: #00ff00;
            height: 150px;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            overflow-y: auto;
            margin-bottom: 15px;
            border: 2px solid #2c3e50;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5);
        }

        .display-line {
            margin-bottom: 3px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .display-controls {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .display-checkbox {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
            color: #2c3e50;
        }

        .display-checkbox input {
            width: 14px;
            height: 14px;
        }

        .footer {
            text-align: center;
            padding: 10px;
            background: #f8f9fa;
            border-top: 2px solid #dee2e6;
            color: #6c757d;
            font-size: 12px;
        }

        .specs-panel {
            background: linear-gradient(145deg, #e3f2fd, #bbdefb);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            border-left: 5px solid #2196f3;
        }

        .specs-title {
            font-size: 16px;
            font-weight: 600;
            color: #1976d2;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .specs-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
        }

        .spec-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 8px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 4px;
            font-size: 12px;
        }

        .timestamp {
            color: #95a5a6;
            font-size: 10px;
            margin-right: 8px;
        }

        .program-panel {
            background: linear-gradient(145deg, #f8f9fa, #e9ecef);
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            border: 1px solid #dee2e6;
            margin-top: 20px;
        }

        .program-steps {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin: 10px 0;
        }

        .step-item {
            display: grid;
            grid-template-columns: 40px 1fr 1fr 80px;
            gap: 8px;
            padding: 8px;
            border-bottom: 1px solid #eee;
            align-items: center;
        }

        .step-item:nth-child(even) {
            background: #f5f5f5;
        }

        .step-num {
            font-weight: 600;
            font-size: 12px;
            color: #2c3e50;
            text-align: center;
        }

        .step-voltage,
        .step-time {
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
            text-align: center;
            width: 100%;
        }

        .program-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .program-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 12px;
            transition: all 0.3s;
        }

        .btn-start {
            background: linear-gradient(145deg, #27ae60, #2ecc71);
            color: white;
        }

        .btn-stop {
            background: linear-gradient(145deg, #e74c3c, #c0392b);
            color: white;
        }

        .btn-reset {
            background: linear-gradient(145deg, #3498db, #2980b9);
            color: white;
        }

        .program-status {
            margin-top: 10px;
            font-size: 12px;
            color: #2c3e50;
            font-weight: 600;
        }
    </style>
    <!-- å¼‚æ­¥åŠ è½½Chart.jsï¼Œä¸é˜»å¡é¦–å±æ¸²æŸ“ -->
    <script>
        (function () {
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/chart.js';
            script.async = true;
            script.onload = function () {
                window.chartLoaded = true;
                if (typeof initVoltageWaveChart === 'function') {
                    initVoltageWaveChart();
                }
            };
            document.head.appendChild(script);
        })();
    </script>
</head>

<body>
    <div class="container">
        <header>
            <h1>ğŸ”Œ å¯ç¼–ç¨‹ç”µæºæ§åˆ¶ç³»ç»Ÿ</h1>
            <p class="subtitle">åŸºäºä¸²å£é€šä¿¡çš„ç²¾å¯†ç”µæºå‚æ•°æ§åˆ¶ä¸ç›‘æ§å¹³å°</p>
        </header>

        <div class="content">
            <div class="control-panel">
                <div class="panel-header">
                    <div class="panel-title">âš¡ ç”µæºå‚æ•°æ§åˆ¶</div>
                    <div class="status-indicator">
                        <div class="status-dot" id="statusDot"></div>
                        <span id="statusText">æ–­å¼€è¿æ¥</span>
                    </div>
                </div>

                <div class="parameter-controls">
                    <div class="parameter-box">
                        <div class="parameter-header">
                            <div class="parameter-title">ç”µå‹è®¾å®š (VSET1)</div>
                            <div class="parameter-value" id="voltageValue">13.50V</div>
                        </div>
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>0V</span>
                                <span id="voltageLimit">æœ€å¤§: 25.0V</span>
                            </div>
                            <input type="range" id="voltageSlider" min="0" max="25" step="0.01" value="13.5">

                        </div>
                        <div class="input-group">
                            <input type="number" id="voltageInput" min="0" max="25" step="0.01" value="13.50"
                                oninput="this.value=this.value.replace(/[^0-9.]/g,'')">
                            <button id="setVoltageBtn">è®¾å®šç”µå‹</button>
                        </div>
                    </div>

                    <div class="parameter-box">
                        <div class="parameter-header">
                            <div class="parameter-title">ç”µæµè®¾å®š (ISET1)</div>
                            <div class="parameter-value" id="currentValue">10.00A</div>
                        </div>
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>0A</span>
                                <span id="currentLimit">æœ€å¤§: 10.0A</span>
                            </div>
                            <input type="range" id="currentSlider" min="0" max="10" step="0.01" value="10.00">
                        </div>
                        <div class="input-group">
                            <input type="number" id="currentInput" min="0" max="10" step="0.01" value="10.00"
                                oninput="this.value=this.value.replace(/[^0-9.]/g,'')">
                            <button id="setCurrentBtn">è®¾å®šç”µæµ</button>
                        </div>
                    </div>
                </div>

                <div class="quick-commands">
                    <button class="cmd-btn power-on" id="outputOnBtn">å¼€å¯è¾“å‡º (OUT1)</button>
                    <button class="cmd-btn power-off" id="outputOffBtn">å…³é—­è¾“å‡º (OUT0)</button>
                    <button class="cmd-btn query" id="queryVoltageBtn">æŸ¥è¯¢ç”µå‹ (VSET1?)</button>
                    <button class="cmd-btn query" id="queryOutputVoltageBtn">æŸ¥è¯¢å®é™…ç”µå‹ (VOUT1?)</button>
                    <button class="cmd-btn query" id="queryCurrentBtn">æŸ¥è¯¢ç”µæµ (IOUT1?)</button>
                    <button class="cmd-btn" id="readAllBtn">è¯»å–æ‰€æœ‰å‚æ•°</button>
                </div>

                <div class="serial-controls">
                    <div class="serial-header">
                        <div class="panel-title">ğŸ”§ ä¸²å£é…ç½®</div>
                        <div id="serialStatus">ä¸²å£æœªè¿æ¥</div>
                    </div>

                    <div class="serial-config">
                        <div class="config-group">
                            <label for="portSelect">é€‰æ‹©ä¸²å£</label>
                            <select id="portSelect" disabled>
                                <option value="">è¯·å…ˆæ‰«æä¸²å£</option>
                            </select>
                        </div>

                        <div class="config-group">
                            <label for="baudRate">æ³¢ç‰¹ç‡</label>
                            <select id="baudRate">
                                <option value="9600">9600</option>
                                <option value="19200">19200</option>
                                <option value="38400">38400</option>
                                <option value="57600">57600</option>
                                <option value="115200">115200</option>
                            </select>
                        </div>
                    </div>

                    <div class="action-buttons">
                        <button class="action-btn scan" id="scanBtn">æ‰«æä¸²å£</button>
                        <button class="action-btn connect" id="connectBtn" disabled>è¿æ¥</button>
                        <button class="action-btn disconnect" id="disconnectBtn" disabled>æ–­å¼€</button>
                        <button class="action-btn clear" id="clearBtn">æ¸…ç©ºæ˜¾ç¤º</button>
                    </div>
                </div>

                <div class="program-panel">
                    <div class="panel-header">
                        <div class="panel-title">ğŸ“ 50æ­¥ç”µå‹ç¼–ç¨‹</div>
                    </div>

                    <div class="program-steps" id="programSteps">
                        <!-- åŠ¨æ€ç”Ÿæˆ50æ­¥ -->
                    </div>

                    <!-- æ–°å¢å¾ªç¯é…ç½®åŒºåŸŸ -->
                    <div class="cycle-config"
                        style="margin: 15px 0; padding: 10px; background: #f5f5f5; border-radius: 8px; border: 1px solid #ddd;">
                        <div class="panel-title" style="font-size: 14px; margin-bottom: 10px;">ğŸ” å¾ªç¯é…ç½®</div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                            <div class="config-group">
                                <label style="font-size: 12px; font-weight: 600;">èµ·å§‹æ­¥éª¤</label>
                                <input type="number" id="cycleStartStep" min="1" max="50" value="1"
                                    style="padding: 5px; border: 1px solid #ddd; border-radius: 4px; text-align: center; width: 100%;">
                            </div>
                            <div class="config-group">
                                <label style="font-size: 12px; font-weight: 600;">ç»“æŸæ­¥éª¤</label>
                                <input type="number" id="cycleEndStep" min="1" max="50" value="5"
                                    style="padding: 5px; border: 1px solid #ddd; border-radius: 4px; text-align: center; width: 100%;">
                            </div>
                            <div class="config-group">
                                <label style="font-size: 12px; font-weight: 600;">å¾ªç¯æ¬¡æ•°</label>
                                <input type="number" id="cycleCount" min="1" max="999" value="1"
                                    style="padding: 5px; border: 1px solid #ddd; border-radius: 4px; text-align: center; width: 100%;">
                                <label style="font-size: 10px; color: #999; margin-top: 2px;">0=æ— é™å¾ªç¯</label>
                            </div>
                        </div>
                    </div>

                    <div class="program-controls">
                        <button class="program-btn btn-start" id="startProgramBtn" disabled>å¯åŠ¨ç¼–ç¨‹</button>
                        <button class="program-btn btn-stop" id="stopProgramBtn" disabled>åœæ­¢ç¼–ç¨‹</button>
                        <button class="program-btn btn-reset" id="resetProgramBtn">é‡ç½®å‚æ•°</button>
                        <!-- æ–°å¢å¯¼å…¥å¯¼å‡ºæŒ‰é’® -->
                        <button class="program-btn" style="background: #9b59b6; color: white;"
                            id="exportConfigBtn">å¯¼å‡ºJSON</button>
                        <button class="program-btn" style="background: #f39c12; color: white;"
                            id="importConfigBtn">å¯¼å…¥JSON</button>
                        <input type="file" id="importFileInput" accept=".json" style="display: none;">
                    </div>

                    <div class="program-status" id="programStatus">çŠ¶æ€ï¼šæœªè¿è¡Œ</div>
                </div>

                <div class="specs-panel">
                    <div class="specs-title">
                        <span>ğŸ“‹ ç³»ç»Ÿè§„æ ¼å‚æ•°</span>
                    </div>
                    <div class="specs-grid">
                        <div class="spec-item">
                            <span class="spec-label">æœ€å¤§ç”µå‹</span>
                            <span class="spec-value">25.0 V</span>
                        </div>
                        <div class="spec-item">
                            <span class="spec-label">æœ€å¤§ç”µæµ</span>
                            <span class="spec-value">10.0 A</span>
                        </div>
                        <div class="spec-item">
                            <span class="spec-label">ç¼“å†²å¤§å°</span>
                            <span class="spec-value">30 bytes</span>
                        </div>
                        <div class="spec-item">
                            <span class="spec-label">é»˜è®¤æ³¢ç‰¹ç‡</span>
                            <span class="spec-value">9600</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="display-panel">
                <div class="panel-header">
                    <div class="panel-title">ğŸ“Š ä¸²å£é€šä¿¡ç›‘æ§ & ç”µå‹æ³¢å½¢</div>
                    <div id="bufferStatus">ç¼“å†²åŒº: 0/30</div>
                </div>

                <div style="height: 200px; margin-bottom: 15px;">
                    <canvas id="voltageWaveChart"></canvas>
                </div>

                <div class="display-area" id="displayArea">
                    <div class="display-line info">å¯ç¼–ç¨‹ç”µæºæ§åˆ¶ç³»ç»Ÿå°±ç»ª</div>
                    <div class="display-line info">æ”¯æŒå‘½ä»¤: VSET1, ISET1, OUT1/OUT0, VSET1?, VOUT1?, IOUT1?</div>
                    <div class="display-line info">æœ€å¤§ç”µå‹: 25.0V | æœ€å¤§ç”µæµ: 10.0A</div>
                </div>

                <div class="display-controls">
                    <label class="display-checkbox">
                        <input type="checkbox" id="autoScroll" checked>
                        <span>è‡ªåŠ¨æ»šåŠ¨</span>
                    </label>
                    <label class="display-checkbox">
                        <input type="checkbox" id="showTimestamp" checked>
                        <span>æ˜¾ç¤ºæ—¶é—´æˆ³</span>
                    </label>
                    <label class="display-checkbox">
                        <input type="checkbox" id="hexDisplay">
                        <span>åå…­è¿›åˆ¶æ˜¾ç¤º</span>
                    </label>
                    <label class="display-checkbox">
                        <input type="checkbox" id="debugMode">
                        <span>è°ƒè¯•æ¨¡å¼</span>
                    </label>
                </div>

                <div style="margin-top: 15px;">
                    <div class="panel-title" style="margin-bottom: 8px; font-size: 16px;">ğŸ”§ æ‰‹åŠ¨å‘½ä»¤å‘é€</div>
                    <div class="input-group">
                        <input type="text" id="manualCommand" placeholder="è¾“å…¥è‡ªå®šä¹‰å‘½ä»¤..." disabled
                            oninput="this.value=this.value.replace(/[^0-9a-zA-Z?:]/g,'')">
                        <button id="sendCommandBtn" disabled>å‘é€å‘½ä»¤</button>
                    </div>
                    <div style="display: flex; gap: 8px; margin-top: 8px; flex-wrap: wrap;">
                        <button class="cmd-btn" onclick="sendCommand('VSET1:')">VSET1:</button>
                        <button class="cmd-btn" onclick="sendCommand('ISET1:')">ISET1:</button>
                        <button class="cmd-btn" onclick="sendCommand('VSET1?')">VSET1?</button>
                        <button class="cmd-btn" onclick="sendCommand('VOUT1?')">VOUT1?</button>
                        <button class="cmd-btn" onclick="sendCommand('IOUT1?')">IOUT1?</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="footer">
            <p>ğŸ”Œ å¯ç¼–ç¨‹ç”µæºæ§åˆ¶ç³»ç»Ÿ v1.0 | åŸºäºWeb Serial API | æ”¯æŒChrome 89+ / Edge 89+</p>
            <p>âš ï¸ ä½¿ç”¨å‰è¯·ç¡®ä¿ç”µæºè®¾å¤‡å·²æ­£ç¡®è¿æ¥å¹¶é…ç½®ä¸ºæ­£ç¡®çš„é€šä¿¡å‚æ•°</p>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let port = null;
        let reader = null;
        let writer = null;
        let isConnected = false;
        let receiveBuffer = [];
        const MAX_BUFFER_SIZE = 30;
        let stopReading = false;
        let programRunning = false;
        let currentStep = 0;
        let programTimer = null;
        let programStepsData = [];
        let lastExecutedStepNum = 0;
        let voltageWaveChart = null;
        let voltageData = [];
        let timeData = []; // æ–°å¢ï¼šè®°å½•æ—¶é—´æˆ³ï¼ˆç§’ï¼‰
        let startTime = null; // æ–°å¢ï¼šè®°å½•æ³¢å½¢èµ·å§‹æ—¶é—´
        const MAX_DATA_POINTS = 50;
        let lastVoltageChangeTime = null; // æ–°å¢ï¼šè®°å½•ä¸Šä¸€æ¬¡ç”µå‹å˜æ›´çš„æ—¶é—´æˆ³ï¼ˆæ¯«ç§’ï¼‰
        let firstVoltageChangeTime = null; // æ–°å¢ï¼šç¬¬ä¸€æ¬¡ç”µå‹å˜æ›´çš„åŸºå‡†æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
        let programContext = { validSteps: [], validStepIndexes: [] };

        let modeData = {
            mode1: [],
            mode2: [],
            mode3: [],
            mode4: [],
            mode5: []
        };
        let currentActiveMode = 'mode1';

        let currentCycle = 0; // å½“å‰å¾ªç¯æ¬¡æ•°
        let cycleStartStep = 1; // å¾ªç¯èµ·å§‹æ­¥
        let cycleEndStep = 5; // å¾ªç¯ç»“æŸæ­¥
        let cycleTotal = 1; // æ€»å¾ªç¯æ¬¡æ•°ï¼ˆ0=æ— é™ï¼‰

        // æ–°å¢DOMå…ƒç´ å˜é‡ï¼ˆåœ¨åŸæœ‰DOMå…ƒç´ åŒºæœ«å°¾æ·»åŠ ï¼‰
        const saveModeBtn = document.getElementById('saveModeBtn') || { disabled: false, addEventListener: () => { } };
        const loadModeBtn = document.getElementById('loadModeBtn') || { disabled: false, addEventListener: () => { } };
        const exportModeBtn = document.getElementById('exportModeBtn') || { disabled: false, addEventListener: () => { } };
        const importModeBtn = document.getElementById('importModeBtn') || { disabled: false, addEventListener: () => { } };
        const importFileInput = document.getElementById('importFileInput') || { disabled: false, addEventListener: () => { } };
        const modeSelect = document.getElementById('modeSelect') || { value: 'mode1', addEventListener: () => { } };

        const cycleStartStepInput = document.getElementById('cycleStartStep') || { value: 1 };
        const cycleEndStepInput = document.getElementById('cycleEndStep') || { value: 5 };
        const cycleCountInput = document.getElementById('cycleCount') || { value: 1 };

        // DOMå…ƒç´ 
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const serialStatus = document.getElementById('serialStatus');
        const bufferStatus = document.getElementById('bufferStatus');
        const displayArea = document.getElementById('displayArea');
        const voltageSlider = document.getElementById('voltageSlider');
        const voltageInput = document.getElementById('voltageInput');
        const voltageValue = document.getElementById('voltageValue');
        const currentSlider = document.getElementById('currentSlider');
        const currentInput = document.getElementById('currentInput');
        const currentValue = document.getElementById('currentValue');
        const setVoltageBtn = document.getElementById('setVoltageBtn');
        const setCurrentBtn = document.getElementById('setCurrentBtn');
        const outputOnBtn = document.getElementById('outputOnBtn');
        const outputOffBtn = document.getElementById('outputOffBtn');
        const queryVoltageBtn = document.getElementById('queryVoltageBtn');
        const queryOutputVoltageBtn = document.getElementById('queryOutputVoltageBtn');
        const queryCurrentBtn = document.getElementById('queryCurrentBtn');
        const readAllBtn = document.getElementById('readAllBtn');
        const manualCommand = document.getElementById('manualCommand');
        const sendCommandBtn = document.getElementById('sendCommandBtn');
        const portSelect = document.getElementById('portSelect');
        const baudRate = document.getElementById('baudRate');
        const scanBtn = document.getElementById('scanBtn');
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const clearBtn = document.getElementById('clearBtn');
        const autoScroll = document.getElementById('autoScroll');
        const showTimestamp = document.getElementById('showTimestamp');
        const hexDisplay = document.getElementById('hexDisplay');
        const debugMode = document.getElementById('debugMode');
        const programSteps = document.getElementById('programSteps');
        const startProgramBtn = document.getElementById('startProgramBtn');
        const stopProgramBtn = document.getElementById('stopProgramBtn');
        const resetProgramBtn = document.getElementById('resetProgramBtn');
        const programStatus = document.getElementById('programStatus');

        // åˆå§‹åŒ–ç”µå‹æ³¢å½¢å›¾è¡¨
        function initVoltageWaveChart() {
            const ctx = document.getElementById('voltageWaveChart');
            if (!ctx) {
                addDisplayLine('é”™è¯¯ï¼šæ³¢å½¢å›¾è¡¨å®¹å™¨æœªæ‰¾åˆ°', 'error');
                return;
            }
            const chartCtx = ctx.getContext('2d');

            voltageWaveChart = new Chart(chartCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'è¾“å‡ºç”µå‹ (V)',
                        data: [],
                        borderColor: '#2ecc71',
                        backgroundColor: 'rgba(46, 204, 113, 0.1)',
                        borderWidth: 2,
                        tension: 0.2,
                        fill: true,
                        pointRadius: 3,
                        pointBackgroundColor: '#2ecc71'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: { display: true, text: 'ç´¯è®¡æ—¶é—´ (ç§’)' }, // æ¨ªè½´è¯´æ˜ä¿®æ”¹
                            ticks: {
                                maxTicksLimit: 10,
                                autoSkip: true,
                                callback: function (_, index) {
                                    return voltageWaveChart.data.labels[index] || '';
                                }
                            },
                            grid: { color: 'rgba(0,0,0,0.05)' }
                        },
                        y: {
                            title: { display: true, text: 'ç”µå‹ (V)' },
                            min: 0,
                            max: 25,
                            ticks: { stepSize: 5 },
                            grid: { color: 'rgba(0,0,0,0.05)' }
                        }
                    },
                    animation: { duration: 100 },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: { font: { size: 12 } }
                        },
                        tooltip: {
                            callbacks: {
                                title: function (tooltipItems) {
                                    return 'é—´éš”æ—¶é—´: ' + tooltipItems[0].label;
                                },
                                label: function (context) {
                                    return 'è¾“å‡ºç”µå‹: ' + context.raw.toFixed(2) + 'V';
                                }
                            }
                        }
                    }
                }
            });
            // åˆå§‹åŒ–ç©ºæ•°æ®ï¼ˆæ— æ—¶é—´/ç”µå‹ï¼‰
            timeData = [];
            voltageData = [];
            voltageWaveChart.data.labels = [];
            voltageWaveChart.data.datasets[0].data = [];
            voltageWaveChart.update('none');
        }

        // æ›´æ–°æ³¢å½¢æ•°æ®
        function updateVoltageWave(voltage) {
            if (!voltageWaveChart) return;

            const currentTime = new Date().getTime(); // å½“å‰æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
            let totalSec = 0.0; // ä¸ç¬¬ä¸€æ¬¡æ“ä½œçš„ç´¯è®¡ç§’æ•°

            // é¦–æ¬¡å˜æ›´ï¼šè®°å½•åŸºå‡†æ—¶é—´ï¼Œç´¯è®¡æ—¶é—´ä¸º0.0s
            if (!firstVoltageChangeTime) {
                firstVoltageChangeTime = currentTime;
                totalSec = 0.0;
            } else {
                // éé¦–æ¬¡ï¼šè®¡ç®—ä¸ç¬¬ä¸€æ¬¡çš„ç´¯è®¡æ—¶é—´ï¼ˆæ¯«ç§’â†’ç§’ï¼Œä¿ç•™1ä½å°æ•°ï¼‰
                totalSec = ((currentTime - firstVoltageChangeTime) / 1000).toFixed(1);
            }
            const totalNum = parseFloat(totalSec);

            // æ•°æ®è¶…é™åˆ™ç§»é™¤æœ€æ—©çš„ç‚¹
            if (voltageData.length >= MAX_DATA_POINTS) {
                voltageData.shift();
                timeData.shift();
                voltageWaveChart.data.labels.shift();
            }

            // è¿½åŠ æ–°æ•°æ®ï¼ˆæ˜¾ç¤ºã€ŒX.Xsã€ï¼‰
            voltageData.push(voltage);
            timeData.push(totalNum);
            voltageWaveChart.data.labels.push(totalSec + 's');
            voltageWaveChart.data.datasets[0].data = voltageData;

            // å¼ºåˆ¶æ›´æ–°å›¾è¡¨
            voltageWaveChart.update('none');
        }

        // æ›´æ–°è¿æ¥çŠ¶æ€
        function updateConnectionStatus(connected) {
            isConnected = connected;
            statusDot.classList.toggle('status-connected', connected);
            statusText.textContent = connected ? 'å·²è¿æ¥' : 'æ–­å¼€è¿æ¥';
            serialStatus.textContent = connected ? 'ä¸²å£å·²è¿æ¥' : 'ä¸²å£æœªè¿æ¥';

            const controls = [setVoltageBtn, setCurrentBtn, outputOnBtn, outputOffBtn,
                queryVoltageBtn, queryOutputVoltageBtn, queryCurrentBtn,
                readAllBtn, manualCommand, sendCommandBtn, startProgramBtn];

            controls.forEach(control => {
                if (control) control.disabled = !connected;
            });

            connectBtn.disabled = connected;
            disconnectBtn.disabled = !connected;
            portSelect.disabled = connected;
            baudRate.disabled = connected;
            scanBtn.disabled = connected;
        }

        // æ·»åŠ æ˜¾ç¤ºè¡Œ
        function addDisplayLine(text, type = 'info') {
            const line = document.createElement('div');
            line.className = `display-line ${type}`;

            if (showTimestamp.checked) {
                const now = new Date();
                const timestamp = now.toTimeString().split(' ')[0] + '.' +
                    now.getMilliseconds().toString().padStart(3, '0');
                const timestampSpan = document.createElement('span');
                timestampSpan.className = 'timestamp';
                timestampSpan.textContent = `[${timestamp}]`;
                line.appendChild(timestampSpan);
            }

            const textSpan = document.createElement('span');
            textSpan.textContent = text;
            line.appendChild(textSpan);

            displayArea.appendChild(line);

            receiveBuffer.push(text);
            if (receiveBuffer.length > MAX_BUFFER_SIZE) {
                receiveBuffer.shift();
                if (displayArea.children.length > 50) {
                    displayArea.removeChild(displayArea.firstChild);
                }
            }

            bufferStatus.textContent = `ç¼“å†²åŒº: ${receiveBuffer.length}/${MAX_BUFFER_SIZE}`;

            if (autoScroll.checked) {
                displayArea.scrollTop = displayArea.scrollHeight;
            }
        }

        // æ£€æŸ¥æµè§ˆå™¨æ”¯æŒ
        function checkWebSerialSupport() {
            const isSupported = 'serial' in navigator;

            if (!isSupported) {
                addDisplayLine('é”™è¯¯ï¼šå½“å‰æµè§ˆå™¨ä¸æ”¯æŒ Web Serial API', 'error');
                addDisplayLine('æç¤ºï¼šè¯·ä½¿ç”¨ Chrome 89+ æˆ– Edge 89+ æµè§ˆå™¨', 'info');

                scanBtn.disabled = true;
                connectBtn.disabled = true;
                disconnectBtn.disabled = true;

                return false;
            }

            addDisplayLine('æµè§ˆå™¨æ”¯æŒ Web Serial API', 'success');
            return true;
        }

        // æ‰«æå¯ç”¨ä¸²å£
        async function scanSerialPorts() {
            try {
                addDisplayLine('æ­£åœ¨æ‰«æä¸²å£...', 'info');

                const port = await navigator.serial.requestPort();
                const ports = await navigator.serial.getPorts();

                portSelect.innerHTML = '';

                if (ports.length === 0) {
                    portSelect.innerHTML = '<option value="">æœªæ‰¾åˆ°å¯ç”¨ä¸²å£</option>';
                    addDisplayLine('æœªæ‰¾åˆ°å¯ç”¨ä¸²å£ã€‚è¯·ç¡®ä¿è®¾å¤‡å·²è¿æ¥ã€‚', 'info');
                } else {
                    ports.forEach((port, index) => {
                        const option = document.createElement('option');
                        option.value = index;
                        const portInfo = port.getInfo();
                        let portName = 'ä¸²å£ ' + (index + 1);
                        if (portInfo.usbVendorId && portInfo.usbProductId) {
                            portName += ' (USBè®¾å¤‡)';
                        }
                        option.textContent = portName;
                        portSelect.appendChild(option);
                    });
                    connectBtn.disabled = false;
                    addDisplayLine('æ‰¾åˆ° ' + ports.length + ' ä¸ªå¯ç”¨ä¸²å£', 'success');
                }

            } catch (error) {
                if (error.name === 'NotFoundError') {
                    addDisplayLine('å·²å–æ¶ˆä¸²å£æƒé™ç”³è¯·', 'info');
                } else {
                    addDisplayLine('æ‰«æä¸²å£æ—¶å‡ºé”™: ' + error.message, 'error');
                }
            }
        }

        // è¿æ¥åˆ°ä¸²å£
        async function connectToPort() {
            try {
                disconnectBtn.disabled = true;

                if (port) {
                    await disconnectPort();
                }

                const ports = await navigator.serial.getPorts();
                const selectedIndex = parseInt(portSelect.value);

                if (isNaN(selectedIndex) || selectedIndex >= ports.length) {
                    addDisplayLine('è¯·é€‰æ‹©æœ‰æ•ˆçš„ä¸²å£', 'error');
                    return;
                }

                port = ports[selectedIndex];

                try {
                    await port.open({
                        baudRate: parseInt(baudRate.value),
                        dataBits: 8,
                        stopBits: 1,
                        parity: 'none',
                        flowControl: 'none'
                    });
                } catch (openError) {
                    await new Promise(resolve => setTimeout(resolve, 500));
                    await port.open({
                        baudRate: parseInt(baudRate.value),
                        dataBits: 8,
                        stopBits: 1,
                        parity: 'none',
                        flowControl: 'none'
                    });
                }

                updateConnectionStatus(true);
                addDisplayLine('å·²è¿æ¥åˆ°ä¸²å£ï¼Œæ³¢ç‰¹ç‡: ' + baudRate.value, 'success');
                readFromPort();

            } catch (error) {
                addDisplayLine('è¿æ¥å¤±è´¥: ' + error.message, 'error');

                disconnectBtn.disabled = isConnected;
                port = null;
                updateConnectionStatus(false);
            }
        }

        // ä»ä¸²å£è¯»å–æ•°æ®
        let dataBuffer = '';
        async function readFromPort() {
            stopReading = false;
            try {
                const decoder = new TextDecoder();

                while (port && port.readable && !stopReading) {
                    reader = port.readable.getReader();

                    try {
                        while (true) {
                            if (stopReading) break;

                            const readPromise = reader.read();
                            const timeoutPromise = new Promise((_, reject) =>
                                setTimeout(() => reject(new Error('è¯»å–è¶…æ—¶')), 3000)
                            );

                            let result;
                            try {
                                result = await Promise.race([readPromise, timeoutPromise]);
                            } catch (timeoutErr) {
                                if (timeoutErr.message === 'è¯»å–è¶…æ—¶' && !stopReading) {
                                    continue;
                                } else {
                                    break;
                                }
                            }

                            const { value, done } = result;
                            if (done || stopReading) break;

                            const text = decoder.decode(value);
                            dataBuffer += text;

                            if (dataBuffer.includes('\n') || dataBuffer.includes('\r')) {
                                const lines = dataBuffer.split(/[\n\r]+/);
                                dataBuffer = lines.pop() || '';

                                lines.forEach(line => {
                                    if (line.trim()) {
                                        let displayText;
                                        if (hexDisplay.checked) {
                                            displayText = Array.from(new TextEncoder().encode(line))
                                                .map(b => b.toString(16).padStart(2, '0').toUpperCase())
                                                .join(' ');
                                        } else {
                                            displayText = line;
                                        }
                                        addDisplayLine(displayText, 'incoming');
                                        parsePowerResponse(displayText);
                                    }
                                });
                            }
                        }
                    } catch (readError) {
                        if (isConnected && !stopReading) {
                            addDisplayLine('è¯»å–æ•°æ®æ—¶å‡ºé”™: ' + readError.message, 'error');
                        }
                    } finally {
                        if (reader) {
                            try { reader.releaseLock(); } catch (e) { }
                            reader = null;
                        }
                    }
                }
            } catch (error) {
                if (isConnected && !stopReading) {
                    addDisplayLine('è¯»å–å¾ªç¯é”™è¯¯: ' + error.message, 'error');
                }
            }
        }

        // è§£æç”µæºå“åº”æ•°æ®
        function parsePowerResponse(response) {
            const cleanResponse = response.trim();

            if (debugMode.checked) {
                addDisplayLine('åŸå§‹å“åº”: "' + cleanResponse + '"', 'info');
            }

            // å¢å¼ºç”µå‹è§£æï¼šåŒ¹é…VSET/VOUT/çº¯æ•°å­—+Vçš„åœºæ™¯
            const voltageRegex = /(VSET1:|VOUT1:|)(\d+\.\d+)\s*V?/i;
            const voltageMatch = cleanResponse.match(voltageRegex);
            if (voltageMatch && voltageMatch[2]) {
                const voltage = parseFloat(voltageMatch[2]);
                if (!isNaN(voltage)) {
                    addDisplayLine('æ£€æµ‹åˆ°ç”µå‹: ' + voltage.toFixed(2) + 'V', 'success');
                    updateVoltageWave(voltage); // è§¦å‘æ³¢å½¢æ›´æ–°
                }
            }

            if (cleanResponse.includes('A') && !cleanResponse.includes('ISET')) {
                const currentMatch = cleanResponse.match(/(\d+\.\d+)\s*A?/);
                if (currentMatch) {
                    const current = parseFloat(currentMatch[1]);
                    if (!isNaN(current)) {
                        addDisplayLine('æ£€æµ‹åˆ°ç”µæµ: ' + current.toFixed(2) + 'A', 'success');
                    }
                }
            }
        }

        // å‘é€å‘½ä»¤åˆ°ä¸²å£
        async function sendSerialCommand(command) {
            if (!port || !isConnected) {
                addDisplayLine('é”™è¯¯ï¼šä¸²å£æœªè¿æ¥', 'error');
                return false;
            }

            try {
                if (!command.endsWith('\n')) {
                    command += '\n';
                }

                addDisplayLine('å‘é€: ' + command.trim(), 'outgoing');

                const encoder = new TextEncoder();
                const data = encoder.encode(command);

                writer = port.writable.getWriter();
                await writer.write(data);
                writer.releaseLock();

                return true;

            } catch (error) {
                addDisplayLine('å‘é€å¤±è´¥: ' + error.message, 'error');
                return false;
            }
        }

        // ç”µæºæ§åˆ¶å‘½ä»¤å‡½æ•°
        function setVoltage(value) {
            const formattedValue = parseFloat(value).toFixed(2);
            if (formattedValue > 25.0) {
                addDisplayLine('é”™è¯¯ï¼šç”µå‹ä¸èƒ½è¶…è¿‡25.0Vï¼ˆå½“å‰ï¼š' + formattedValue + 'Vï¼‰', 'error');
                return;
            }

            const command = 'VSET1:' + formattedValue;
            if (sendSerialCommand(command)) {
                voltageValue.textContent = formattedValue + 'V';
                addDisplayLine('è®¾ç½®ç”µå‹: ' + formattedValue + 'V', 'success');
                // æ–°å¢ï¼šå¼ºåˆ¶æ›´æ–°æ³¢å½¢ï¼ˆå…³é”®ï¼ç¡®ä¿è®¾ç½®ç”µå‹åæ³¢å½¢æœ‰ååº”ï¼‰
                updateVoltageWave(parseFloat(formattedValue));
            }
        }

        function setCurrent(value) {
            const formattedValue = parseFloat(value).toFixed(2);
            if (formattedValue > 10.0) {
                addDisplayLine('é”™è¯¯ï¼šç”µæµä¸èƒ½è¶…è¿‡10.0Aï¼ˆå½“å‰ï¼š' + formattedValue + 'Aï¼‰', 'error');
                return;
            }

            const command = 'ISET1:' + formattedValue;
            if (sendSerialCommand(command)) {
                currentValue.textContent = formattedValue + 'A';
                addDisplayLine('è®¾ç½®ç”µæµ: ' + formattedValue + 'A', 'success');
            }
        }

        function outputOn() {
            if (sendSerialCommand('OUT1')) {
                addDisplayLine('è¾“å‡ºå¼€å¯', 'success');
            }
        }

        function outputOff() {
            if (sendSerialCommand('OUT0')) {
                addDisplayLine('è¾“å‡ºå…³é—­', 'success');
            }
        }

        function queryVoltage() {
            if (sendSerialCommand('VSET1?')) {
                addDisplayLine('æŸ¥è¯¢ç”µå‹è®¾å®šå€¼...', 'info');
            }
        }

        function queryOutputVoltage() {
            if (sendSerialCommand('VOUT1?')) {
                addDisplayLine('æŸ¥è¯¢å®é™…ç”µå‹å€¼...', 'info');
            }
        }

        function queryCurrent() {
            if (sendSerialCommand('IOUT1?')) {
                addDisplayLine('æŸ¥è¯¢å®é™…ç”µæµå€¼...', 'info');
            }
        }

        function readAllParameters() {
            addDisplayLine('å¼€å§‹è¯»å–æ‰€æœ‰å‚æ•°...', 'info');
            queryVoltage();
            setTimeout(queryOutputVoltage, 300);
            setTimeout(queryCurrent, 600);
        }

        // æ–­å¼€ä¸²å£è¿æ¥
        async function disconnectPort() {
            try {
                stopReading = true;

                if (programRunning) {
                    stopProgram();
                }

                if (reader) {
                    try {
                        await Promise.race([
                            reader.cancel(),
                            new Promise(resolve => setTimeout(resolve, 1000))
                        ]);
                    } catch (e) { }
                    reader = null;
                }

                if (writer) {
                    try {
                        await Promise.race([
                            writer.close(),
                            new Promise(resolve => setTimeout(resolve, 500))
                        ]);
                    } catch (e) { }
                    writer = null;
                }

                if (port) {
                    try {
                        if (port.readable || port.writable) {
                            await port.close();
                        }
                    } catch (e) {
                        addDisplayLine('å…³é—­ç«¯å£æ—¶çš„æ¬¡è¦é”™è¯¯: ' + e.message, 'info');
                    }
                    port = null;
                }

                updateConnectionStatus(false);
                addDisplayLine('å·²å®Œå…¨æ–­å¼€ä¸²å£è¿æ¥', 'success');

            } catch (error) {
                addDisplayLine('æ–­å¼€è¿æ¥æ—¶å‡ºé”™: ' + error.message, 'error');
                port = null;
                reader = null;
                writer = null;
                stopReading = true;
                updateConnectionStatus(false);
            }
        }

        // æ¸…ç©ºæ•°æ®å±•ç¤ºåŒºåŸŸ
        function clearDisplay() {
            displayArea.innerHTML = '';
            receiveBuffer = [];
            bufferStatus.textContent = 'ç¼“å†²åŒº: 0/30';
            addDisplayLine('æ˜¾ç¤ºåŒºåŸŸå·²æ¸…ç©º', 'info');
        }

        // æ‰‹åŠ¨å‘é€å‘½ä»¤
        function sendCommand(cmd) {
            if (isConnected) {
                manualCommand.value = cmd;
                sendSerialCommand(cmd);
                manualCommand.value = '';
            } else {
                addDisplayLine('è¯·å…ˆè¿æ¥ä¸²å£', 'error');
            }
        }

        // åˆå§‹åŒ–50æ­¥ç”µå‹ç¼–ç¨‹é¢æ¿ï¼ˆè™šæ‹Ÿæ»šåŠ¨ä¼˜åŒ–ï¼‰
        // åˆå§‹åŒ–50æ­¥ç”µå‹ç¼–ç¨‹é¢æ¿ï¼ˆå…¼å®¹æ¨¡å¼å¯¼å…¥çš„å‚æ•°ä¼ å…¥ï¼‰
        function initProgramSteps(initData = null) {
            programSteps.innerHTML = '';
            programStepsData = [];

            // ä¼˜å…ˆä½¿ç”¨ä¼ å…¥çš„åˆå§‹åŒ–æ•°æ®ï¼ˆåç»­å¯¼å…¥JSONç”¨ï¼‰ï¼Œæ— åˆ™åˆå§‹åŒ–ç©ºæ•°æ®
            const initSteps = initData || Array(50).fill({ voltage: null, time: null, isEdited: false });

            for (let i = 0; i < 50; i++) {
                const stepData = initSteps[i] || { voltage: null, time: null, isEdited: false };
                const stepItem = document.createElement('div');
                stepItem.className = 'step-item';
                stepItem.innerHTML = `
            <div class="step-num">${i + 1}</div>
            <div style="display: flex; align-items: center; gap: 5px;">
                <input type="number" class="step-voltage" min="0" max="25" step="0.01" 
                       value="${stepData.voltage !== null ? stepData.voltage.toFixed(2) : ''}" 
                       placeholder="æœªè®¾ç½®">
                <span style="font-size: 12px;">(V)</span>
            </div>
            <div style="display: flex; align-items: center; gap: 5px;">
                <input type="number" class="step-time" min="0.1" max="300" step="0.1" 
                       value="${stepData.time !== null ? stepData.time.toFixed(1) : ''}" 
                       placeholder="æœªè®¾ç½®">
                <span style="font-size: 12px;">(s)</span>
            </div>
        `;
                programSteps.appendChild(stepItem);

                // åˆå§‹åŒ–æ•°æ®
                programStepsData.push({
                    voltage: stepData.voltage,
                    time: stepData.time,
                    isEdited: stepData.isEdited
                });

                // ç»‘å®šè¾“å…¥äº‹ä»¶ï¼ˆä»…å½“è¾“å…¥å€¼æ—¶æ‰æ ‡è®°ä¸ºå·²ç¼–è¾‘ï¼‰
                const voltageInput = stepItem.querySelector('.step-voltage');
                const timeInput = stepItem.querySelector('.step-time');

                voltageInput.addEventListener('change', function () {
                    let value = parseFloat(this.value);
                    // ç©ºå€¼åˆ™é‡ç½®ä¸ºnull
                    if (isNaN(value)) {
                        this.value = '';
                        programStepsData[i].voltage = null;
                        programStepsData[i].isEdited = false;
                    } else {
                        value = Math.max(0, Math.min(25, value)).toFixed(2);
                        this.value = value;
                        programStepsData[i].voltage = parseFloat(value);
                        programStepsData[i].isEdited = true;
                    }
                });

                timeInput.addEventListener('change', function () {
                    let value = parseFloat(this.value);
                    // ç©ºå€¼åˆ™é‡ç½®ä¸ºnull
                    if (isNaN(value)) {
                        this.value = '';
                        programStepsData[i].time = null;
                        programStepsData[i].isEdited = false;
                    } else {
                        value = Math.max(0.1, Math.min(300, value)).toFixed(1);
                        this.value = value;
                        programStepsData[i].time = parseFloat(value);
                        programStepsData[i].isEdited = true;
                    }
                });
            }
        }

        // å¯åŠ¨ç”µå‹ç¼–ç¨‹
        // å¯åŠ¨ç”µå‹ç¼–ç¨‹ï¼ˆæ–°å¢å¾ªç¯é€»è¾‘ï¼‰
        function startProgram() {
            if (programRunning) return;

            // è·å–å¾ªç¯é…ç½®
            cycleStartStep = parseInt(cycleStartStepInput.value) || 1;
            cycleEndStep = parseInt(cycleEndStepInput.value) || 5;
            cycleTotal = parseInt(cycleCountInput.value) || 1;

            // éªŒè¯å¾ªç¯é…ç½®
            if (cycleStartStep < 1 || cycleStartStep > 50) {
                addDisplayLine('é”™è¯¯ï¼šèµ·å§‹æ­¥éª¤å¿…é¡»åœ¨1-50ä¹‹é—´', 'error');
                return;
            }
            if (cycleEndStep < 1 || cycleEndStep > 50) {
                addDisplayLine('é”™è¯¯ï¼šç»“æŸæ­¥éª¤å¿…é¡»åœ¨1-50ä¹‹é—´', 'error');
                return;
            }
            if (cycleStartStep > cycleEndStep) {
                addDisplayLine('é”™è¯¯ï¼šèµ·å§‹æ­¥éª¤ä¸èƒ½å¤§äºç»“æŸæ­¥éª¤', 'error');
                return;
            }

            lastExecutedStepNum = 0;
            currentCycle = 0; // é‡ç½®å½“å‰å¾ªç¯æ¬¡æ•°

            // ç­›é€‰å¾ªç¯èŒƒå›´å†…çš„æœ‰æ•ˆæ­¥éª¤
            const validSteps = [];
            const validStepIndexes = [];
            for (let i = cycleStartStep - 1; i <= cycleEndStep - 1; i++) {
                const step = programStepsData[i];
                if (step && step.voltage !== null && step.time !== null) {
                    validSteps.push({
                        voltage: step.voltage,
                        time: step.time
                    });
                    validStepIndexes.push(i + 1);
                }
            }

            if (validSteps.length === 0) {
                addDisplayLine(`é”™è¯¯ï¼š${cycleStartStep}-${cycleEndStep}æ­¥å†…æ— æœ‰æ•ˆé…ç½®`, 'error');
                return;
            }

            programRunning = true;
            currentStep = 0;
            programContext = {
                validSteps: validSteps,
                validStepIndexes: validStepIndexes,
                cycleStart: cycleStartStep,
                cycleEnd: cycleEndStep
            };

            startProgramBtn.disabled = true;
            stopProgramBtn.disabled = false;
            programStatus.textContent = `çŠ¶æ€ï¼šè¿è¡Œä¸­ï¼ˆå¾ªç¯${currentCycle + 1}/${cycleTotal || 'æ— é™'} | æ­¥éª¤èŒƒå›´${cycleStartStep}-${cycleEndStep}ï¼‰`;
            addDisplayLine(`å¯åŠ¨ç”µå‹ç¼–ç¨‹ | å¾ªç¯æ¬¡æ•°ï¼š${cycleTotal || 'æ— é™'} | æ­¥éª¤èŒƒå›´ï¼š${cycleStartStep}-${cycleEndStep} | æœ‰æ•ˆæ­¥éª¤æ•°ï¼š${validSteps.length}`, 'success');

            // æ‰§è¡Œç¬¬ä¸€æ­¥
            executeStepWithCycle(currentStep);
        }

        // æ‰§è¡Œå•æ­¥ç”µå‹è®¾ç½®
        // æ‰§è¡Œå•æ­¥+å¾ªç¯é€»è¾‘
        function executeStepWithCycle(stepIndex) {
            const { validSteps, validStepIndexes } = programContext;
            if (!programRunning) return;

            // å•è½®æ­¥éª¤æ‰§è¡Œå®Œæ¯•
            if (stepIndex >= validSteps.length) {
                currentCycle++;
                // åˆ¤æ–­æ˜¯å¦ç»§ç»­å¾ªç¯
                if (cycleTotal === 0 || currentCycle < cycleTotal) {
                    // ç»§ç»­ä¸‹ä¸€è½®å¾ªç¯
                    programStatus.textContent = `çŠ¶æ€ï¼šè¿è¡Œä¸­ï¼ˆå¾ªç¯${currentCycle + 1}/${cycleTotal || 'æ— é™'} | æ­¥éª¤èŒƒå›´${cycleStartStep}-${cycleEndStep}ï¼‰`;
                    addDisplayLine(`å®Œæˆç¬¬${currentCycle}è½®å¾ªç¯ï¼Œå¼€å§‹ç¬¬${currentCycle + 1}è½®`, 'info');
                    currentStep = 0; // é‡ç½®æ­¥éª¤ç´¢å¼•
                    executeStepWithCycle(currentStep);
                } else {
                    // å¾ªç¯ç»“æŸ
                    stopProgram();
                    addDisplayLine(`æ‰€æœ‰å¾ªç¯æ‰§è¡Œå®Œæˆï¼ˆå…±${currentCycle}è½®ï¼‰`, 'success');
                    programStatus.textContent = `çŠ¶æ€ï¼šå·²å®Œæˆï¼ˆå…±${currentCycle}è½®å¾ªç¯ï¼‰`;
                }
                return;
            }

            const step = validSteps[stepIndex];
            const originalStepNum = validStepIndexes[stepIndex];
            lastExecutedStepNum = originalStepNum;

            addDisplayLine(`[å¾ªç¯${currentCycle + 1}/${cycleTotal || 'æ— é™'}] æ‰§è¡Œç¬¬${originalStepNum}æ­¥ï¼šç”µå‹=${step.voltage.toFixed(2)}Vï¼Œä¿æŒ${step.time}ç§’`, 'info');
            setVoltage(step.voltage);

            programTimer = setTimeout(() => {
                currentStep++;
                programStatus.textContent = `çŠ¶æ€ï¼šè¿è¡Œä¸­ï¼ˆå¾ªç¯${currentCycle + 1}/${cycleTotal || 'æ— é™'} | å½“å‰ç¬¬${originalStepNum}æ­¥ï¼‰`;
                executeStepWithCycle(currentStep);
            }, step.time * 1000);
        }

        // åœæ­¢ç¼–ç¨‹
        function stopProgram() {
            if (!programRunning) return;

            programRunning = false;
            clearTimeout(programTimer);
            startProgramBtn.disabled = false;
            stopProgramBtn.disabled = true;

            const stopStep = lastExecutedStepNum || 0;
            programStatus.textContent = `çŠ¶æ€ï¼šå·²åœæ­¢ï¼ˆå¾ªç¯${currentCycle}/${cycleTotal || 'æ— é™'} | åœæ­¢äºç¬¬${stopStep}æ­¥ï¼‰`;
            addDisplayLine(`ç”µå‹ç¼–ç¨‹å·²åœæ­¢ï¼ˆå·²æ‰§è¡Œ${currentCycle}è½®å¾ªç¯ | åœæ­¢äºç¬¬${stopStep}æ­¥ï¼‰`, 'info');
        }

        // é‡ç½®ç¼–ç¨‹å‚æ•°
        function resetProgram() {
            if (programRunning) {
                stopProgram();
            }
            initProgramSteps();
            // é‡ç½®å¾ªç¯é…ç½®è¾“å…¥æ¡†
            cycleStartStepInput.value = 1;
            cycleEndStepInput.value = 5;
            cycleCountInput.value = 1;
            // é‡ç½®å¾ªç¯å˜é‡
            cycleStartStep = 1;
            cycleEndStep = 5;
            cycleTotal = 1;
            currentCycle = 0;

            programStatus.textContent = 'çŠ¶æ€ï¼šæœªè¿è¡Œ';
            addDisplayLine('ç”µå‹ç¼–ç¨‹å‚æ•°åŠå¾ªç¯é…ç½®å·²é‡ç½®', 'info');
        }

        // å¯¼å‡ºå½“å‰50æ­¥é…ç½®ä¸ºJSONæ¨¡æ¿ï¼ˆæ–°å¢ï¼‰
        // å¯¼å‡ºå½“å‰50æ­¥é…ç½®+å¾ªç¯é…ç½®ä¸ºJSONæ¨¡æ¿
        function exportProgramConfig() {
            const exportData = {
                mode: "è‡ªå®šä¹‰æ¨¡å¼",
                createTime: new Date().toLocaleString(),
                cycleConfig: { // æ–°å¢å¾ªç¯é…ç½®
                    startStep: parseInt(cycleStartStepInput.value) || 1,
                    endStep: parseInt(cycleEndStepInput.value) || 5,
                    cycleCount: parseInt(cycleCountInput.value) || 1
                },
                steps: JSON.parse(JSON.stringify(programStepsData))
            };
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);

            const a = document.createElement('a');
            a.href = url;
            a.download = `ç”µæºç¼–ç¨‹é…ç½®_${new Date().getTime()}.json`;
            document.body.appendChild(a);
            a.click();

            setTimeout(() => {
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }, 100);

            addDisplayLine('å·²å¯¼å‡ºå½“å‰é…ç½®ï¼ˆå«å¾ªç¯å‚æ•°ï¼‰ä¸ºJSONæ¨¡æ¿æ–‡ä»¶', 'success');
        }

        // å¯¼å…¥JSONæ¨¡æ¿æ–‡ä»¶ï¼ˆå«å¾ªç¯é…ç½®ï¼‰
        function importProgramConfig(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (programRunning) {
                addDisplayLine('è¯·å…ˆåœæ­¢æ­£åœ¨è¿è¡Œçš„ç¼–ç¨‹å†å¯¼å…¥é…ç½®', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const importData = JSON.parse(e.target.result);
                    if (!importData.steps || !Array.isArray(importData.steps) || importData.steps.length !== 50) {
                        throw new Error('JSONæ¨¡æ¿æ ¼å¼é”™è¯¯ï¼šå¿…é¡»åŒ…å«50æ­¥é…ç½®');
                    }

                    // éªŒè¯å¹¶æ ¼å¼åŒ–æ­¥éª¤æ•°æ®
                    const validSteps = importData.steps.map(step => ({
                        voltage: step.voltage !== null ? Math.max(0, Math.min(25, step.voltage)) : null,
                        time: step.time !== null ? Math.max(0.1, Math.min(300, step.time)) : null,
                        isEdited: step.isEdited || false
                    }));

                    // åŠ è½½æ­¥éª¤é…ç½®
                    initProgramSteps(validSteps);

                    // åŠ è½½å¾ªç¯é…ç½®ï¼ˆå¦‚æœæœ‰ï¼‰
                    if (importData.cycleConfig) {
                        cycleStartStepInput.value = importData.cycleConfig.startStep || 1;
                        cycleEndStepInput.value = importData.cycleConfig.endStep || 5;
                        cycleCountInput.value = importData.cycleConfig.cycleCount || 1;
                        addDisplayLine('å·²å¯¼å…¥å¾ªç¯é…ç½®ï¼šèµ·å§‹æ­¥=' + (importData.cycleConfig.startStep || 1) +
                            'ï¼Œç»“æŸæ­¥=' + (importData.cycleConfig.endStep || 5) +
                            'ï¼Œå¾ªç¯æ¬¡æ•°=' + (importData.cycleConfig.cycleCount || 1), 'info');
                    }

                    addDisplayLine('æˆåŠŸå¯¼å…¥JSONæ¨¡æ¿é…ç½®ï¼ˆå«æ­¥éª¤+å¾ªç¯å‚æ•°ï¼‰', 'success');
                } catch (error) {
                    addDisplayLine('å¯¼å…¥å¤±è´¥ï¼š' + error.message, 'error');
                }
            };
            reader.readAsText(file);
        }

        // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨
        function initEventListeners() {
            voltageSlider.addEventListener('input', function () {
                const value = parseFloat(this.value).toFixed(2);
                voltageInput.value = value;
                voltageValue.textContent = value + 'V';
            });

            voltageInput.addEventListener('change', function () {
                let value = parseFloat(this.value);
                if (isNaN(value)) value = 0;
                if (value > 25) value = 25;
                if (value < 0) value = 0;

                const formattedValue = value.toFixed(2);
                this.value = formattedValue;
                voltageSlider.value = formattedValue;
                voltageValue.textContent = formattedValue + 'V';
            });

            setVoltageBtn.addEventListener('click', function () {
                setVoltage(voltageInput.value);
            });

            currentSlider.addEventListener('input', function () {
                const value = parseFloat(this.value).toFixed(2);
                currentInput.value = value;
                currentValue.textContent = value + 'A';
            });

            currentInput.addEventListener('change', function () {
                let value = parseFloat(this.value);
                if (isNaN(value)) value = 0;
                if (value > 10) value = 10;
                if (value < 0) value = 0;

                const formattedValue = value.toFixed(2);
                this.value = formattedValue;
                currentSlider.value = formattedValue;
                currentValue.textContent = formattedValue + 'A';
            });

            setCurrentBtn.addEventListener('click', function () {
                setCurrent(currentInput.value);
            });

            outputOnBtn.addEventListener('click', outputOn);
            outputOffBtn.addEventListener('click', outputOff);
            queryVoltageBtn.addEventListener('click', queryVoltage);
            queryOutputVoltageBtn.addEventListener('click', queryOutputVoltage);
            queryCurrentBtn.addEventListener('click', queryCurrent);
            readAllBtn.addEventListener('click', readAllParameters);

            scanBtn.addEventListener('click', scanSerialPorts);
            connectBtn.addEventListener('click', connectToPort);
            disconnectBtn.addEventListener('click', disconnectPort);
            clearBtn.addEventListener('click', clearDisplay);

            manualCommand.addEventListener('keypress', function (e) {
                if (e.key === 'Enter' && manualCommand.value.trim()) {
                    sendSerialCommand(manualCommand.value);
                    manualCommand.value = '';
                }
            });

            sendCommandBtn.addEventListener('click', function () {
                if (manualCommand.value.trim()) {
                    sendSerialCommand(manualCommand.value);
                    manualCommand.value = '';
                }
            });

            window.sendCommand = sendCommand;

            startProgramBtn.addEventListener('click', startProgram);
            stopProgramBtn.addEventListener('click', stopProgram);
            resetProgramBtn.addEventListener('click', resetProgram);
            // ç»‘å®šå¯¼å…¥å¯¼å‡ºäº‹ä»¶ï¼ˆæ–°å¢ï¼‰
            const exportConfigBtn = document.getElementById('exportConfigBtn');
            const importConfigBtn = document.getElementById('importConfigBtn');
            const importFileInput = document.getElementById('importFileInput');

            exportConfigBtn.addEventListener('click', exportProgramConfig);
            importConfigBtn.addEventListener('click', () => importFileInput.click());
            importFileInput.addEventListener('change', importProgramConfig);
        }

        // åˆå§‹åŒ–åº”ç”¨
        function initApp() {
            firstVoltageChangeTime = null; // é¦–æ¬¡æ‰“å¼€é¡µé¢ï¼Œæ— åŸºå‡†æ—¶é—´
            timeData = [];
            voltageData = [];

            addDisplayLine('ç”µæºæ§åˆ¶ç³»ç»Ÿåˆå§‹åŒ–...', 'info');


            if (checkWebSerialSupport()) {
                addDisplayLine('åˆå§‹åŒ–å®Œæˆ', 'success');
                addDisplayLine('ç‚¹å‡»"æ‰«æä¸²å£"æŒ‰é’®å¼€å§‹ä½¿ç”¨', 'info');

                initEventListeners();
                baudRate.value = '9600';

                setTimeout(() => {
                    initProgramSteps();
                }, 500);
                startTime = null;

                if (window.chartLoaded) {
                    initVoltageWaveChart();
                } else {
                    const checkChart = setInterval(() => {
                        if (window.chartLoaded) {
                            initVoltageWaveChart();
                            clearInterval(checkChart);
                        }
                    }, 100);
                }

            } else {
                addDisplayLine('æ›¿ä»£æ–¹æ¡ˆï¼š', 'info');
                addDisplayLine('1. ä½¿ç”¨ Chrome 89+ æˆ– Edge 89+ æµè§ˆå™¨', 'info');
                addDisplayLine('2. é€šè¿‡HTTPSæˆ–localhostè®¿é—®æ­¤é¡µé¢', 'info');
                addDisplayLine('3. æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰æ›´å¤šé”™è¯¯ä¿¡æ¯', 'info');
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', initApp);

        // é¡µé¢å¸è½½å‰æ–­å¼€è¿æ¥
        window.addEventListener('beforeunload', function () {
            if (isConnected && port) {
                disconnectPort();
            }
        });
    </script>
</body>

</html>
